<UserControl x:Class="WaybillWpf.Views.Admin.AdminStatisticsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:viewmodels="clr-namespace:WaybillWpf.ViewModels.Admin"
             xmlns:global="clr-namespace:"
             d:DataContext="{d:DesignInstance Type=global:AdminStatisticsViewModel}"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900">
    
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Фильтр -->
            <RowDefinition Height="*"/>    <!-- Табы -->
        </Grid.RowDefinitions>

        <!-- 1. ПАНЕЛЬ ФИЛЬТРОВ -->
        <Border Grid.Row="0" Background="#F5F5F5" CornerRadius="5" Padding="10" Margin="0,0,0,10" BorderBrush="#DDD" BorderThickness="1">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Период статистики:" VerticalAlignment="Center" FontWeight="Bold" Margin="0,0,10,0"/>
                
                <DatePicker SelectedDate="{Binding StartDate, StringFormat='dd/MM/yyyy'}" Width="120"/>
                <TextBlock Text="—" VerticalAlignment="Center" Margin="5,0"/>
                <DatePicker SelectedDate="{Binding EndDate, StringFormat='dd/MM/yyyy'}" Width="120"/>

                <Button Content="Сформировать отчет" 
                        Command="{Binding LoadStatsCommand}" 
                        Margin="20,0,0,0" Padding="15,5" 
                        Background="#007ACC" Foreground="White" FontWeight="Bold"/>
            </StackPanel>
        </Border>

        <!-- 2. ВКЛАДКИ ОТЧЕТОВ -->
        <TabControl Grid.Row="1">
            
            <!-- === ВКЛАДКА 1: ОБЩАЯ СВОДКА (KPI) === -->
            <TabItem Header="Дашборд">
                <Grid Margin="20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Карточка 1: Листы -->
                    <Border Grid.Column="0" Background="#E3F2FD" CornerRadius="10" Padding="20" Margin="10">
                        <StackPanel>
                            <TextBlock Text="Путевых листов" FontSize="14" Foreground="Gray"/>
                            <TextBlock Text="{Binding Dashboard.TotalWaybills}" FontSize="36" FontWeight="Bold" Foreground="#1565C0"/>
                            <TextBlock Text="шт." HorizontalAlignment="Right" Foreground="Gray"/>
                        </StackPanel>
                    </Border>

                    <!-- Карточка 2: Пробег -->
                    <Border Grid.Column="1" Background="#E8F5E9" CornerRadius="10" Padding="20" Margin="10">
                        <StackPanel>
                            <TextBlock Text="Общий пробег" FontSize="14" Foreground="Gray"/>
                            <TextBlock Text="{Binding Dashboard.TotalMileage, StringFormat=F1}" FontSize="36" FontWeight="Bold" Foreground="#2E7D32"/>
                            <TextBlock Text="км" HorizontalAlignment="Right" Foreground="Gray"/>
                        </StackPanel>
                    </Border>

                    <!-- Карточка 3: Топливо -->
                    <Border Grid.Column="2" Background="#FFF3E0" CornerRadius="10" Padding="20" Margin="10">
                        <StackPanel>
                            <TextBlock Text="Расход топлива (Факт)" FontSize="14" Foreground="Gray"/>
                            <TextBlock Text="{Binding Dashboard.TotalFuelConsumed, StringFormat=F1}" FontSize="36" FontWeight="Bold" Foreground="#EF6C00"/>
                            <TextBlock Text="литров" HorizontalAlignment="Right" Foreground="Gray"/>
                        </StackPanel>
                    </Border>

                    <TextBlock Grid.Row="1" Grid.ColumnSpan="3" Text="* Данные указаны за выбранный период на основе завершенных путевых листов." 
                               HorizontalAlignment="Center" Margin="0,20,0,0" Foreground="Gray" FontStyle="Italic"/>
                </Grid>
            </TabItem>

            <!-- === ВКЛАДКА 2: ТОПЛИВО (ПЛАН/ФАКТ) === -->
            <TabItem Header="Эффективность расхода">
                <DataGrid ItemsSource="{Binding FuelReport}" 
                          AutoGenerateColumns="False" IsReadOnly="True" 
                          CanUserAddRows="False" HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Автомобиль" Binding="{Binding CarModel}" Width="*"/>
                        <DataGridTextColumn Header="Пробег (км)" Binding="{Binding Distance, StringFormat=F1}" Width="100"/>
                        
                        <!-- Основные колонки -->
                        <DataGridTextColumn Header="Факт (вручную)" Binding="{Binding FactFuel, StringFormat=F1}" Width="120" FontWeight="Bold"/>
                        <DataGridTextColumn Header="Норма (по времени)" Binding="{Binding NormFuel, StringFormat=F1}" Width="140"/>
                        
                        <!-- Разница -->
                        <DataGridTextColumn Header="Разница" Binding="{Binding Difference, StringFormat=F1}" Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Style.Triggers>
                                        <!-- Если больше 0 (Перерасход) -> Красный -->
                                        <DataTrigger Binding="{Binding Difference}" Value="{x:Null}">
                                            <Setter Property="Foreground" Value="Black"/>
                                        </DataTrigger>
                                        <!-- Трюк для конвертации в цвет требует конвертера, но можно просто оставить черным или использовать простой триггер, если Difference > 0 -->
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- === ВКЛАДКА 3: ПО МАШИНАМ === -->
            <TabItem Header="Пробег по Машинам">
                <DataGrid ItemsSource="{Binding MileageByCarReport}" AutoGenerateColumns="False" IsReadOnly="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Машина" Binding="{Binding EntityName}" Width="*"/>
                        <DataGridTextColumn Header="Кол-во поездок" Binding="{Binding TripsCount}" Width="150"/>
                        <DataGridTextColumn Header="Суммарный пробег (км)" Binding="{Binding TotalDistance, StringFormat=F1}" Width="180" FontWeight="Bold"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
            
            <!-- === ВКЛАДКА 4: ПО ВОДИТЕЛЯМ === -->
            <TabItem Header="Пробег по Водителям">
                <DataGrid ItemsSource="{Binding MileageByDriverReport}" AutoGenerateColumns="False" IsReadOnly="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Водитель" Binding="{Binding EntityName}" Width="*"/>
                        <DataGridTextColumn Header="Кол-во поездок" Binding="{Binding TripsCount}" Width="150"/>
                        <DataGridTextColumn Header="Суммарный пробег (км)" Binding="{Binding TotalDistance, StringFormat=F1}" Width="180" FontWeight="Bold"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

        </TabControl>
    </Grid>
</UserControl>